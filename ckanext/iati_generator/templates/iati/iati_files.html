{% extends "admin/base.html" %}

{% block primary_content_inner %}
  <h1>{{ _("IATI files") }}</h1>

  {% if iati_files %}

    <form method="get" class="form-inline mb-3">
      <label for="namespace" class="mr-2">
        {{ _("Namespace") }}
      </label>

      <select name="namespace" id="namespace" class="form-select mr-2"
              onchange="this.form.submit()">
        <option value="">{{ _("All") }}</option>

        {% for ns in h.iati_namespaces() %}
          <option value="{{ ns }}"
            {% if ns == namespace %}selected{% endif %}>
            {{ ns }}
          </option>
        {% endfor %}
      </select>
    </form>
    {% for namespace, pending in pending_files.items() %}
      {% if pending.organization or pending.activity %}
        <div class="alert alert-warning">
          <strong>{{ _("Namespace") }}:</strong> {{ namespace }}
          <strong>{{ _("Missing files") }}</strong>

          <details style="margin-top: 8px;">
            <summary style="cursor: pointer; font-weight: 600;">
              {{ _("Show missing files") }}
            </summary>

            {% if pending.organization %}
              <div style="margin-top: 10px;">
                <strong>{{ _("Organization") }}</strong>
                <ul style="margin-top: 4px;">
                  {% for ft in pending.organization %}
                    <li>
                      {{ ft.name.replace("_", " ").title() }}
                    </li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}

            {% if pending.activity %}
              <div style="margin-top: 10px;">
                <strong>{{ _("Activities") }}</strong>
                <ul style="margin-top: 4px;">
                  {% for ft in pending.activity %}
                    <li>
                      {{ ft.name.replace("_", " ").title() }}
                    </li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
          </details>
        </div>
      {% endif %}
    {% endfor %}

    <table class="table table-striped table-bordered">
      <thead>
        <tr>
          <th>{{ _("Namespace") }}</th>
          <th>{{ _("File type") }}</th>
          <th>{{ _("Resource") }}</th>
          <th>{{ _("Validation") }}</th>
          <th>{{ _("Notes") }}</th>
        </tr>
      </thead>
       <tbody>
        {% for row in iati_files %}
          <tr>
            <td>{{ row.namespace }}</td>
            <td>{{ row.file_type }}</td>
            <td>
                {# the blueprint already provides us with the resource URL #}
              <a href="{{ row.resource_url }}">
                {{ row.resource_name }}
              </a>
            </td>
            <td class="status-cell">
              {% if row.valid %}
                <span class="bg bg-valid">
                  {{ _('Valid') }}
                </span>
              {% else %}
                <span class="bg bg-invalid">
                  {{ _('Invalid') }}
                </span>
              {% endif %}
            </td>
            <td>{{ row.notes }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <div class="alert alert-info">
      <h3>{{ _("No IATI files found") }}</h3>
      <p>
        {{ _("There are no mandatory IATI CSV components loaded yet.") }}
      </p>
    </div>

    {% for namespace, pending in pending_files.items() %}
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">
            {{ _("Pending mandatory files") }}
            {% if namespace != "__none__" %}
              <small>({{ namespace }})</small>
            {% endif %}
          </h3>
        </div>

        <div class="panel-body">
          <div class="row">
            <div class="col-md-6">
              <h4>{{ _("Organization") }}</h4>
              {% if pending.organization %}
                <ul>
                  {% for ft in pending.organization %}
                    <li>
                      <strong>{{ ft.value }}</strong> – {{ ft.name.replace("_", " ").title() }}
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <span class="label label-success">
                  {{ _("All mandatory organization files uploaded") }}
                </span>
              {% endif %}
            </div>

            <div class="col-md-6">
              <h4>{{ _("Activities") }}</h4>
              {% if pending.activity %}
                <ul>
                  {% for ft in pending.activity %}
                    <li>
                      <strong>{{ ft.value }}</strong> – {{ ft.name.replace("_", " ").title() }}
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <span class="label label-success">
                  {{ _("All mandatory activity files uploaded") }}
                </span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% endfor %}

    <div class="alert alert-warning">
      <h4>{{ _("Getting Started") }}</h4>
      <ol>
        <li>{{ _("Create or select a dataset") }}</li>
        <li>{{ _("Upload CSV resources") }}</li>
        <li>{{ _("Assign IATI namespace and file type") }}</li>
        <li>{{ _("Once mandatory files exist, XML generation will be enabled") }}</li>
      </ol>
    </div>

  {% endif %}
{% endblock %}

{% block content_secondary_nav %}
  {{ super() }}
  <ul class="nav nav-pills">
    <li class="active">
      <a href="{{ h.url_for('iati_generator_admin_files.iati_files_index') }}">{{ _('IATI files') }}</a>
    </li>
  </ul>
{% endblock %}

{% block secondary_content %}
  <section class="module module-narrow module-shallow">
    <h2 class="module-heading"><i class="fa fa-info-circle"></i> {{ _('About IATI') }}</h2>
    <div class="module-content">
      <p>
        {{ _("IATI (International Aid Transparency Initiative) is a global standard for publishing data on development and humanitarian resources.") }}
      </p>
      <p>
        {{ _("This page lists the IATI files configured on resources. It shows whether each file is currently valid, and the date/message of the last validation run.") }}
      </p>
      <p>
        {{ _("OKFN IATI library:") }}
        <a href="https://github.com/okfn/okfn-iati" target="_blank" rel="noopener">
          https://github.com/okfn/okfn-iati
        </a>
      </p>
    </div>
  </section>
{% endblock %}
