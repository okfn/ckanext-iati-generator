{% extends "admin/base.html" %}

{% block primary_content_inner %}
  <h1>{{ _("IATI files") }}</h1>

  {% if iati_files %}

    <form method="get" class="form-inline mb-3">
      <label for="namespace" class="mr-2">
        {{ _("Namespace") }}
      </label>

      <select name="namespace" id="namespace" class="form-select mr-2"
              onchange="this.form.submit()">
        <option value="">{{ _("All") }}</option>

        {% for ns in h.iati_namespaces() %}
          <option value="{{ ns }}"
            {% if ns == namespace %}selected{% endif %}>
            {{ ns }}
          </option>
        {% endfor %}
      </select>
    </form>

    {# Generation section - only show when a specific namespace is selected #}
    {% if namespace %}
      {% set generation_status = h.namespace_ready_for_generation(namespace) %}
      
      <div class="card mb-3">
        <div class="card-header">
          <h3>{{ _("Generate IATI XML Files") }} - {{ namespace }}</h3>
        </div>
        <div class="card-body">
          <div class="row mb-3">
            <div class="col-md-6">
              <h4>{{ _("Organization Files") }}</h4>
              {% if generation_status.organization.complete %}
                <span class="badge bg-success">{{ _("Ready") }}</span>
                <p class="text-success">{{ _("All mandatory components are defined") }}</p>
                <form method="post" action="{{ h.url_for('iati_generator_admin_files.generate_iati') }}" style="display: inline;">
                  <input type="hidden" name="namespace" value="{{ namespace }}">
                  <input type="hidden" name="file_category" value="organization">
                  <button type="submit" class="btn btn-primary">
                    <i class="fa fa-play"></i> {{ _("Generate Organization XML") }}
                  </button>
                </form>
              {% else %}
                <span class="badge bg-warning">{{ _("Not Ready") }}</span>
                <p class="text-warning">{{ _("Missing mandatory components:") }} {{ generation_status.organization.missing|join(', ') }}</p>
              {% endif %}
            </div>
            
            <div class="col-md-6">
              <h4>{{ _("Activity Files") }}</h4>
              {% if generation_status.activities.complete %}
                <span class="badge bg-success">{{ _("Ready") }}</span>
                <p class="text-success">{{ _("All mandatory components are defined") }}</p>
                <form method="post" action="{{ h.url_for('iati_generator_admin_files.generate_iati') }}" style="display: inline;">
                  <input type="hidden" name="namespace" value="{{ namespace }}">
                  <input type="hidden" name="file_category" value="activities">
                  <button type="submit" class="btn btn-primary">
                    <i class="fa fa-play"></i> {{ _("Generate Activities XML") }}
                  </button>
                </form>
              {% else %}
                <span class="badge bg-warning">{{ _("Not Ready") }}</span>
                <p class="text-warning">{{ _("Missing mandatory components:") }} {{ generation_status.activities.missing|join(', ') }}</p>
              {% endif %}
            </div>
          </div>
          
          <div class="alert alert-info">
            <i class="fa fa-info-circle"></i>
            {{ _("To view the generated files, visit:") }}
            <ul>
              <li><a href="/iati/{{ namespace }}/organization.xml" target="_blank">/iati/{{ namespace }}/organization.xml</a></li>
              <li><a href="/iati/{{ namespace }}/activities.xml" target="_blank">/iati/{{ namespace }}/activities.xml</a></li>
            </ul>
          </div>
        </div>
      </div>
    {% endif %}

    <table class="table table-striped table-bordered">
      <thead>
        <tr>
          <th>{{ _("Namespace") }}</th>
          <th>{{ _("File type") }}</th>
          <th>{{ _("Resource") }}</th>
          <th>{{ _("Validation") }}</th>
          <th>{{ _("Notes") }}</th>
        </tr>
      </thead>
       <tbody>
        {% for row in iati_files %}
          <tr>
            <td>{{ row.namespace }}</td>
            <td>{{ row.file_type }}</td>
            <td>
                {# the blueprint already provides us with the resource URL #}
              <a href="{{ row.resource_url }}">
                {{ row.resource_name }}
              </a>
            </td>
            <td class="status-cell">
              {% if row.valid %}
                <span class="bg bg-valid">
                  {{ _('Valid') }}
                </span>
              {% else %}
                <span class="bg bg-invalid">
                  {{ _('Invalid') }}
                </span>
              {% endif %}
            </td>
            <td>{{ row.notes }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>{{ _("No IATI files found.") }}</p>
  {% endif %}
{% endblock %}

{% block content_secondary_nav %}
  {{ super() }}
  <ul class="nav nav-pills">
    <li class="active">
      <a href="{{ h.url_for('iati_generator_admin_files.iati_files_index') }}">{{ _('IATI files') }}</a>
    </li>
  </ul>
{% endblock %}

{% block secondary_content %}
  <section class="module module-narrow module-shallow">
    <h2 class="module-heading"><i class="fa fa-info-circle"></i> {{ _('About IATI') }}</h2>
    <div class="module-content">
      <p>
        {{ _("IATI (International Aid Transparency Initiative) is a global standard for publishing data on development and humanitarian resources.") }}
      </p>
      <p>
        {{ _("This page lists the IATI files configured on resources. It shows whether each file is currently valid, and the date/message of the last validation run.") }}
      </p>
      <p>
        {{ _("Select a specific namespace to generate IATI XML files when all mandatory components are defined.") }}
      </p>
      <p>
        {{ _("OKFN IATI library:") }}
        <a href="https://github.com/okfn/okfn-iati" target="_blank" rel="noopener">
          https://github.com/okfn/okfn-iati
        </a>
      </p>
    </div>
  </section>
{% endblock %}
