{% extends "package/read_base.html" %}

{% block primary_content_inner %}
<section class="module">
  <div class="module-content">
    <form method="post" action="{{ h.url_for('iati_generator.generate_test_iati', package_id=pkg.id) }}">
      {{ h.csrf_input() }}
      <div class="mb-3">
        <label for="resource-select" class="form-label">{{ _("Select a resource") }}</label>
        <select id="resource-select" name="resource_id" class="form-select" required>
          <option value="" disabled selected>{{ _("Choose a resource") }}</option>
          {% for resource in pkg_dict.resources %}
            {% if resource.format.lower() in ['csv'] and resource.get('url_type') == 'upload' %}
              <option value="{{ resource.id }}">{{ resource.name or resource.id }}</option>
            {% endif %}
          {% endfor %}
        </select>
      </div>

      <button type="submit" class="btn btn-primary">{{ _("Generate IATI XML File") }}</button>
    </form>

    {% if logs %}
      <div class="mt-4">
        <h3>{{ _("Generation Logs") }}</h3>
        <ul class="list-group">
          {% for line in logs %}
            {% if "error" in line.lower() or "failed" in line.lower() %}
              <li class="list-group-item list-group-item-danger">‚ùå {{ line }}</li>
            {% elif "success" in line.lower() %}
              <li class="list-group-item list-group-item-success">‚úÖ {{ line }}</li>
            {% else %}
              <li class="list-group-item list-group-item-info">üîπ {{ line }}</li>
            {% endif %}
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    {% if xml_url %}
      <div class="mt-4">
        <a href="{{ xml_url }}" class="btn btn-success" target="_blank" download>
          {{ _("Download XML File") }}
        </a>
      </div>
    {% endif %}
  </div>
</section>
{% endblock %}


{% block secondary_content %}
  {% if public_iati_links and public_iati_links|length %}
    <section class="module module-narrow">
      <h2 class="module-heading">{{ _("IATI public links") }}</h2>
      <div class="module-content">
        <ul class="list-unstyled">
          {% for item in public_iati_links %}
            <li class="mb-2">
              <a href="{{ item.url }}" target="_blank" rel="noopener">
                {{ item.label }}
              </a>
              {% if item.status == 'valid' %}
                <span class="label label-success" title="{{_('Valid')}}">‚úì</span>
              {% else %}
                <span class="label label-danger" title="{{_('Invalid')}}">!</span>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </div>
    </section>
  {% else %}
    <section class="module module-narrow">
      <h2 class="module-heading">{{ _("IATI public links") }}</h2>
      <div class="module-content">
        <p class="muted">{{ _("No IATI files found for this dataset yet.") }}</p>
      </div>
    </section>
  {% endif %}
{% endblock %}
