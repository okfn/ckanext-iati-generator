
{% import 'macros/form.html' as form %}

{% set data = data or {} %}
{% set errors = errors or {} %}
{% set action = form_action or h.url_for(dataset_type ~ '_resource.new', id=pkg_name) %}


<form id="resource-edit" method="post" action="{{ action }}" data-module="basic-form resource-form" enctype="multipart/form-data">
  {{ h.csrf_input() }}
  {% block stages %}
    {# An empty stages variable will not show the stages #}
    {% if stage %}
      {% snippet 'package/snippets/stages.html', stages=stage, pkg_name=pkg_name, dataset_type=dataset_type %}
    {% endif %}
  {% endblock %}

  {% block errors %}{{ form.errors(error_summary) }}{% endblock %}

  <input name="id" value="{{ data.id }}" type="hidden"/>

  {% block basic_fields %}
    {% block basic_fields_url %}
      {% set is_upload = (data.url_type == 'upload') %}
      {% snippet 'package/snippets/resource_upload_field.html',
        data=data,
        errors=errors,
        is_url=data.url and not is_upload,
        is_upload=is_upload,
        is_upload_enabled=h.uploads_enabled(),
        url_label=_('URL'),
        upload_label=_('File'),
        placeholder=_('http://example.com/external-data.csv') %}
    {% endblock %}

    {% block basic_fields_name %}
      {{ form.input('name', id='field-name', label=_('Name'), placeholder=_('eg. January 2011 Gold Prices'), value=data.name, error=errors.name, classes=['control-full']) }}
    {% endblock %}

    {% block basic_fields_description %}
      {{ form.markdown('description', id='field-description', label=_('Description'), placeholder=_('Some useful notes about the data'), value=data.description, error=errors.description) }}
    {% endblock %}

    {% block basic_fields_format %}
      {% set format_attrs = {'data-module': 'autocomplete', 'data-module-source': '/api/2/util/resource/format_autocomplete?incomplete=?'} %}
      {% call form.input('format', id='field-format', label=_('Format'), placeholder=_('eg. CSV, XML or JSON'), value=data.format, error=errors.format, classes=['control-medium'], attrs=format_attrs) %}
        <span class="info-block info-block-small">
          <i class="fa fa-info-circle"></i>
          {{ _('This will be guessed automatically. Leave blank if you wish') }}
        </span>
      {% endcall %}
    {% endblock %}
  {% endblock basic_fields %}

  {% block metadata_fields %}
    {% if include_metadata %}
      {# TODO: Where do these come from, they don't exist in /package/new_package_form.html #}
      {# {{ form.select('resource_type', id='field-type', label=_('Resource Type'), options=[{'value': 'empty', 'text': _('Select a typeâ€¦')}], selected="empty", error=errors.type) }} #}

      {{ form.input('last_modified', id='field-last-modified', label=_('Last Modified'), placeholder=_('eg. 2012-06-05'), value=data.last_modified, error=errors.last_modified, classes=[]) }}

      {{ form.input('size', id='field-size', label=_('File Size'), placeholder=_('eg. 1024'), value=data.size, error=errors.size, classes=[]) }}

      {{ form.input('mimetype', id='field-mimetype', label=_('MIME Type'), placeholder=_('eg. application/json'), value=data.mimetype, error=errors.mimetype, classes=[]) }}

      {{ form.input('mimetype_inner', id='field-mimetype-inner', label=_('MIME Type'), placeholder=_('eg. application/json'), value=data.mimetype_inner, error=errors.mimetype_inner, classes=[]) }}
    {% endif %}
  {% endblock %}


 {# --- IATI section (campos planos -> CKAN los convierte a extras) ------ #}
  {% block iati_fields %}
    {# Prefill leyendo de extras actuales #}
    {% set _extras = data.extras if data and data.get('extras') else [] %}
    {% set ns_val = '' %}
    {% set ref_val = '' %}
    {% for e in _extras %}
      {% if e.key == 'iati_namespace' %}
        {% set ns_val = e.value %}
      {% elif e.key == 'iati_file_reference' %}
        {% set ref_val = e.value %}
      {% endif %}
    {% endfor %}

    <section class="module module-narrow">
      <h3 class="module-heading">{{ _("IATI") }}</h3>
      <div class="module-content">
        <p class="help-block">
          {{ _("If this resource must be used to build the final XML IATI file, define how. It's not required to make this dataset public.") }}
        </p>

        <div class="control-group">
          <label class="control-label" for="field-iati-namespace">{{ _("IATI namespace") }}</label>
          <div class="controls">
            <input
              type="text"
              id="field-iati-namespace"
              name="iati_namespace"            {# <- campo plano #}
              value="{{ ns_val }}"
              maxlength="90"
              class="control-full"
              placeholder="{{ _('eg. XM-DAC-46002 or my-org') }}"
            >
            <p class="info-block info-block-small">
              <i class="fa fa-info-circle"></i>
              {{ _("Leave empty for a single IATI file environment.") }}
            </p>
          </div>
        </div>

        <div class="control-group">
          <label class="control-label" for="field-iati-file-reference">{{ _("IATI file reference") }}</label>
          <div class="controls">
            {% if 'get_iati_file_reference_options' in h %}
              {% set opts = h.get_iati_file_reference_options() %}
              <select id="field-iati-file-reference" name="iati_file_reference" class="control-medium">
                <option value="">{{ _("- Select -") }}</option>
                {% for o in opts %}
                  <option value="{{ o.value }}" {% if o.value == ref_val %}selected{% endif %}>{{ o.text }}</option>
                {% endfor %}
              </select>
            {% else %}
              <input
                type="text"
                id="field-iati-file-reference"
                name="iati_file_reference"     {# <- campo plano #}
                value="{{ ref_val }}"
                class="control-medium"
                placeholder="{{ _('eg. activities / transactions / ...') }}"
              >
            {% endif %}

            <p class="info-block info-block-small">
              <i class="fa fa-info-circle"></i>
              {{ _("Choose the reference from the IATI enums list.") }}
            </p>
          </div>
        </div>
      </div>
    </section>
  {% endblock iati_fields %}
  {# --------------------------------------------------------------------- #}

  <div class="form-actions">
    {% block delete_button %}
      {% if data.id %}
        {% if h.check_access('resource_delete', {'id': data.id})  %}
          <a class="btn btn-danger pull-left" href="{% url_for dataset_type ~ '_resource.delete', resource_id=data.id, id=pkg_name %}" data-module="confirm-action" data-module-content="{{ _('Are you sure you want to delete this resource?') }}">{% block delete_button_text %}{{ _('Delete') }}{% endblock %}</a>
        {% endif %}
      {% endif %}
    {% endblock %}
    {% if stage %}
      {% block previous_button %}
        <button class="btn btn-default" name="save" value="go-dataset" type="submit">{{ _('Previous') }}</button>
      {% endblock %}
    {% endif %}
    {% block again_button %}
      <button class="btn btn-default" name="save" value="again" type="submit">{{ _('Save & add another') }}</button>
    {% endblock %}
    {% if stage %}
      {% block save_button %}
        <button class="btn btn-primary" name="save" value="go-metadata" type="submit">{% block save_button_text %}{{ _('Finish') }}{% endblock %}</button>
      {% endblock %}
    {% else %}
      {% block add_button %}
        <button class="btn btn-primary" name="save" value="go-dataset-complete" type="submit">{{ _('Add') }}</button>
      {% endblock %}
    {% endif %}
  </div>
</form>
