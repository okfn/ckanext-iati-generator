{% extends "package/read.html" %}

{% block primary_content_inner %}
  <h1>{{ _("IATI files") }}</h1>

    {% if pending_files.organization %}
        <div class="alert alert-warning">
          <details class="missing-files-details">
            <summary class="missing-files-summary">
              {{ _("Files missing for organisation.xml file") }}
            </summary>
            <div class="missing-files-category">
              <ul class="missing-files-list">
                {% for ft in pending_files.organization %}
                  <li>
                    {{ ft.name.replace("_", " ").title() }}
                  </li>
                {% endfor %}
              </ul>
            </div>
          </details>
        </div>
     {% endif %}

    {% if pending_files.activity %}
        <div class="alert alert-warning">
          <details class="missing-files-details">
            <summary class="missing-files-summary">
              {{ _("Files missing for activity.xml file") }}
            </summary>
            <div class="missing-files-category">
              <ul class="missing-files-list">
                {% for ft in pending_files.activity %}
                  <li>
                    {{ ft.name.replace("_", " ").title() }}
                  </li>
                {% endfor %}
              </ul>
            </div>
          </details>
        </div>
    {% endif %}

    {% if package_id and not pending_files.activity %}
      <div class="alert alert-info d-flex flex-row justify-content-between">
        <div class="p-2">
          {{ _("This dataset contains all the required files to generate the activity.xml file.") }}
        </div>
        <div>
          <form action="{{ h.url_for("iati_generator_admin_files.generate_iati_activity_file", package_id=package_id) }}" method="post">
            <button class="btn btn-primary" type="submit">{{ _("Generate activity.xml") }}</button>
          </form>
        </div>
      </div>
    {% endif %}

    {% if package_id and (not pending_files.organization and not pending_files.activity)%}
      <div class="alert alert-info d-flex flex-row justify-content-between">
        <div class="p-2">
          {{ _("This dataset contains all the required files to generate the organisation.xml file.") }}
        </div>
        <div>
          <form action="{{ h.url_for("iati_generator_admin_files.generate_iati_organisation_file", package_id=package_id) }}" method="post">
            <button class="btn btn-primary" type="submit">{{ _("Generate organisation.xml") }}</button>
          </form>
        </div>
      </div>
    {% endif %}

    {% if generation_errors %}
      <div class="module-content">
        <div class="alert alert-danger">
          <details open> {# Quita la palabra 'open' si quieres que empiece cerrado por defecto #}
            
            {# El summary actúa como el título/botón #}
            <summary class="text-danger h3" style="cursor: pointer; outline: none; list-style: none;">
              <i class="fa fa-exclamation-triangle"></i> {{ _("Generation Errors") }}
              <span class="pull-right"><i class="fa fa-chevron-down"></i></span> {# Icono opcional #}
            </summary>
            
            {# Contenido ocultable #}
            <div style="margin-top: 15px;">
                <p>{{ _("The following errors occurred during the last XML generation attempt:") }}</p>
                <table class="table table-condensed table-bordered bg-white">
                  <thead>
                    <tr class="danger">
                      <th>{{ _("Output File Type") }}</th>
                      <th>{{ _("Last Attempt") }}</th>
                      <th>{{ _("Error Detail") }}</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for err in generation_errors %}
                      <tr>
                        <td><strong>{{ err.file_type }}</strong></td>
                        <td><small>{{ err.date }}</small></td>
                        <td class="text-danger"><code>{{ err.error }}</code></td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
            </div>

          </details>
        </div>
      </div>
    {% endif %}

  {% if iati_files %}
    <table class="table table-striped table-bordered">
      <thead>
        <tr>
          <th>{{ _("File type") }}</th>
          <th>{{ _("Resource") }}</th>
        </tr>
      </thead>
       <tbody>
        {% for row in iati_files %}
          <tr>
            <td>{{ row.file_type }}</td>
            <td>
              <a href="{{ row.resource_url }}">
                {{ row.resource_name }}
              </a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <div class="alert alert-warning">
      <h4>{{ _("Getting Started") }}</h4>
      <ol>
        <li>{{ _("Create a dataset and fill the namespace value (so it gets identified as an IATI file)") }}</li>
        <li>{{ _("For each IATI CSV file you have, create a resource on the dataset and upload the file to it.") }}</li>
        <li>{{ _("To each created resource, assign the corresponding IATI file type (it will be available in the resource form).") }}</li>
        <li>{{ _("Once all mandatory files exist, XML generation will be enabled on this page.") }}</li>
      </ol>
    </div>
  {% endif %}

{% endblock %}

{% block content_secondary_nav %}
  {{ super() }}
  <ul class="nav nav-pills">
    <li class="active">
      <a href="{{ h.url_for('iati_generator_admin_files.iati_files_index') }}">{{ _('IATI files') }}</a>
    </li>
  </ul>
{% endblock %}

{% block secondary_content %}
  <section class="module module-narrow module-shallow">
    <h2 class="module-heading"><i class="fa fa-info-circle"></i> {{ _('About IATI') }}</h2>
    <div class="module-content">
      <p>
        {{ _("IATI (International Aid Transparency Initiative) is a global standard for publishing data on development and humanitarian resources.") }}
      </p>
      <p>
        {{ _("This page lists the IATI files configured on resources. It shows whether each file is currently valid, and the date/message of the last validation run.") }}
      </p>
      <p>
        {{ _("OKFN IATI library:") }}
        <a href="https://github.com/okfn/okfn-iati" target="_blank" rel="noopener">
          https://github.com/okfn/okfn-iati
        </a>
      </p>
    </div>
  </section>
{% endblock %}
